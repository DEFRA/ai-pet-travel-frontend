{%- set messages = params.messages if params.messages else [] -%}
{%- set lastUserIndex = -1 -%}
{%- for message in messages -%}
  {%- if message.role === "user" -%}
    {%- set lastUserIndex = loop.index0 -%}
  {%- endif -%}
{%- endfor -%}

<div class="govuk-!-margin-bottom-6">
  <h3 class="govuk-heading-s">Conversation</h3>
  <div class="govuk-!-padding-4 app-conversation-container">
    {% for message in messages %}
      {% if message.role === "user" %}
        <div class="app-user-question-wrapper"{% if loop.index0 == lastUserIndex %} id="latest-question" tabindex="-1" autofocus{% endif %}>
          <div class="app-user-question">
              {{ message.content | safe }}
          </div>
        </div>
        <p class="govuk-body-s govuk-!-text-align-right govuk-!-margin-top-0">
          <strong>You</strong> {% if message.timestamp %}({{ message.timestamp | formatDate("yyyy-MM-dd HH:mm:ss") }}){% endif %}
        </p>
      {% endif %}

      {% if message.role === "assistant" %}
        <div class="app-assistant-response govuk-body govuk-!-width-two-thirds">
            {{ message.content | safe }}
        </div>
        <div class="govuk-!-display-flex govuk-!-justify-content-space-between govuk-!-margin-top-0">
          <p class="govuk-body-s govuk-!-margin-top-0 govuk-!-margin-bottom-0">
            <strong>AI Assistant</strong> {% if message.model %}({{ message.model }}){% endif %} {% if message.timestamp %}({{ message.timestamp | formatDate("yyyy-MM-dd HH:mm:ss") }}){% endif %}
          </p>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>
